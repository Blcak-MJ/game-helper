#pragma once

#include "stdafx.h"

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// 宏定义
#define EXTERNC extern "C"
#define NAKED __declspec(naked)
#define EXPORT __declspec(dllexport)

#define ALCPP EXPORT NAKED
#define ALSTD EXTERNC EXPORT NAKED void __stdcall
#define ALCFAST EXTERNC EXPORT NAKED void __fastcall
#define ALCDECL EXTERNC NAKED void __cdecl
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// 导出函数
#pragma comment(linker, "/EXPORT:CscNetApiGetInterface=_AheadLib_CscNetApiGetInterface,@1")
#pragma comment(linker, "/EXPORT:CscSearchApiGetInterface=_AheadLib_CscSearchApiGetInterface,@2")
#pragma comment(linker, "/EXPORT:OfflineFilesEnable=_AheadLib_OfflineFilesEnable,@3")
#pragma comment(linker, "/EXPORT:OfflineFilesQueryStatus=_AheadLib_OfflineFilesQueryStatus,@4")
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


HMODULE m_hModule = NULL;		// 原始模块句柄

								// 加载原始模块
inline BOOL WINAPI Load()
{
	m_hModule = LoadLibrary(L"C:\\Windows\\System32\\cscapi.dll");
	if (m_hModule == NULL)
	{
		m_hModule = LoadLibrary(L"C:\\Windows\\SysWOW64\\cscapi.dll");
	}

	return (m_hModule != NULL);
}

// 释放原始模块
inline VOID WINAPI Free()
{
	if (m_hModule)
	{
		FreeLibrary(m_hModule);
	}
}

FARPROC WINAPI GetAddress(PCSTR pszProcName)
{
	FARPROC fpAddress;
	CHAR szProcName[64];

	fpAddress = GetProcAddress(m_hModule, pszProcName);
	if (fpAddress == NULL)
	{
		if (HIWORD(pszProcName) == 0)
		{
			wsprintfA(szProcName, "%d", pszProcName);
			pszProcName = szProcName;
		}
	}

	return fpAddress;
}



////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// 导出函数
ALCDECL AheadLib_CscNetApiGetInterface(void)
{
	GetAddress("CscNetApiGetInterface");
	__asm JMP EAX;
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// 导出函数
ALCDECL AheadLib_CscSearchApiGetInterface(void)
{
	GetAddress("CscSearchApiGetInterface");
	__asm JMP EAX;
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// 导出函数
ALCDECL AheadLib_OfflineFilesEnable(void)
{
	GetAddress("OfflineFilesEnable");
	__asm JMP EAX;
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// 导出函数
ALCDECL AheadLib_OfflineFilesQueryStatus(void)
{
	GetAddress("OfflineFilesQueryStatus");
	__asm JMP EAX;
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
